<?php
/*
Core SedLex Plugin
VersionInclude : 3.0
*/ 
/** =*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*
* This PHP class enables the svn management of the plugin with the wordpress.org repository
*/
if (!class_exists("svnAdmin")) {
	class svnAdmin {
		
		var $login ; 
		var $mdp ;
		var $repo ;
		var $folder ;
		
		/** ====================================================================================================================================================
		* Constructor of the class
		* 
		* @return svnAdmin the box object
		*/
		
		function svnAdmin($repo, $login='', $mdp='') {
			$this->login = $login ; 
			$this->mdp = $mdp ; 
			$this->repo = $repo ; 
		}
		
		/** ====================================================================================================================================================
		* List the files and folder on the repository
		* 
		* @param string $base the relative path of the folder to be looked into (from the repository)
		* @param boolean $rec true if the listing should be reccursive
		* @param boolean $credentials true if the repository requires credentials to list files
		* @return array list of files and folder
		*/	
		
		function listFilesInRepository($base="/", $rec=true, $credentials=false) {
			
			$path =  preg_replace("/((^:)\/\/)/", "/", $this->repo . $base); 
			
			$header = "Content-type: text/xml\r\nDepth: 1\r\n" ; 
			if ($credentials) 
				$header .= "Authorization: Basic " . base64_encode($this->login . ":" . $this->mdp) ."\r\n" ;
				
			$params = stream_context_create(
				array ('http' => array (
						'method'  => 'PROPFIND',
						'ignore_errors' => true, // propfind answer correctly a 207 Multi-Status that PHP understand as an error, PHP >= 5.2.10
						'header'  => $header,
						'content' => '<?xml version="1.0"?><D:propfind xmlns:D="DAV:"><D:allprop/></D:propfind>' 
						)
					)
			);
			
			$result = file_get_contents($path, false, $params);
			
			// Now we transform the XML into an array
			
			$doc = new DOMDocument();
			$doc->loadXML($result, LIBXML_NOENT | LIBXML_NONET | LIBXML_NSCLEAN | LIBXML_NOCDATA | LIBXML_COMPACT | LIBXML_NOERROR | LIBXML_NOWARNING);
			$ls=array();
			
			$i=-1;
			foreach($doc->getElementsByTagNameNS ( 'DAV:' , 'response' ) as $response) {
				$i++;
				// We skip the first entry because the first entry is the folder itself
				if ($i===0) {
					continue;
				}
				
				// We get the name of the file/folder
				$res=array();
				$res['href']=$response->getElementsByTagNameNS ( 'DAV:' , 'href' )->item(0)->textContent;
				
				// We check if the entry is a folder
				if($response->getElementsByTagNameNS ( 'DAV:' , 'collection')->length) 
					$res['folder']=true;
				
				// reccursive
				if ($rec) {
					if ($res['collection']) {
						$rec_files = $this->listFilesInRepository($res['href'], $rec, $credentials)  ; 
						$ls = array_merge($ls, $rec_files) ; 
					}
				}
			}
			return($ls);
		}

		/** ====================================================================================================================================================
		* Copy the files in the repository in a local cache
		* 
		* @param string $base the relative path of the folder to be looked into (from the repository)
		* @param boolean $rec true if the listing should be reccursive
		* @param boolean $credentials true if the repository requires credentials to list files
		* @return array list of files and folder
		*/			
		
		function checkout($base, $local, $credentials=false) {
			
			/*$files = $this->listFilesInRepository($base) ; 
			
			$value = 99 ; 
			
			// we delete the repository if exist
			if (is_dir($local)) {
				Utils::rm_rec($local) ; 
			}
			// we create the root file
			if (!is_dir($local)) {
				@mkdir($local, 0777, true) ; 
			}
			*/
			
			$path =  preg_replace("/((^:)\/\/)/", "/", $this->repo . $base); 
			
			$header = "Content-Length: 6\r\nContent-Type: text/plain\r\n" ; 
			$header .= "Authorization: Basic " . base64_encode("sedLex:Isard5994" ) ."\r\n" ;
			if ($credentials) 
				$header .= "Authorization: Basic " . base64_encode($this->login . ":" . $this->mdp) ."\r\n" ;
				
			$params = stream_context_create(
				array ('http' => array (
						'method'  => 'PUT',
						'content' => 'coucou' ,
						'header'  => $header
						)
					)
			);
			echo $path ; 
			$result = file_get_contents($path, false, $params);
			
			print_r($result) ; 
			
			return $value ; 
		}
		

		
		/** ====================================================================================================================================================
		* Update or Checkout the following local cache
		* 
		* @return  integer the return value of the svn command
		*/
		function update_checkout($root, $repository, $print=true) {
			
			echo "#" ; 
			$this->repo = "http://svn.wp-plugins.org/" ; 
			$this->checkout("content-table/trunk/readme.txt2", "") ; 
			echo "#" ; 
			
		}
		
		
		/** ====================================================================================================================================================
		* Update the following local cache
		* 
		* @return 
		*/
		function update($root, $print=true) {
			$value = 99 ; 
			
			chdir($root) ; 
			
			exec($this->cmd." cleanup 2>&1", $out, $value) ; 
			exec($this->cmd." revert --recursive . 2>&1", $out, $value) ; 
			exec($this->cmd." update -r BASE 2>&1", $out, $value) ; 
			
			// On affiche
			if ($print) {
				echo "<p class='console'>\n" ; 
				echo sprintf(__('%s returns the following code: %s', 'SL_framework'), "*Update*", "<b>".$value."</b><br/>")."\n" ; 
				foreach ($out as $l) {
					echo $l."<br/>\n" ; 
				}
				echo "</p>\n" ; 
			}
			
			return $value ; 
		}
		
		/** ====================================================================================================================================================
		* Checkout
		* 
		* @return void
		*/
		function checkout_old($root, $repository, $print=true) {
			$value = 99 ; 
			
			// we delete the repository if exist
			if (is_dir($root)) {
				Utils::rm_rec($root) ; 
			}
			// we create the root file
			if (!is_dir($root)) {
				@mkdir($root, 0777, true) ; 
			}
			
			chdir($root) ; 
			
			exec($this->cmd." -q --non-interactive --ignore-externals --force checkout ".$repository." ".$root." 2>&1", $out, $value) ; 
			
			// On affiche
			if ($print) {
				echo "<p class='console'>\n" ; 
				echo sprintf(__('%s returns the following code: %s ', 'SL_framework'), "*Checkout*", "<b>".$value."</b>")."<br/>\n" ; 
				if ($value == 0) {
					foreach ($out as $l) {
						echo $l."<br/>\n" ; 
					}
				} else {
					echo "\n".__('Checkout has failed! Please retry ...', 'SL_framework')."<br/>\n" ; 
					echo __('Indeed, it is known that the Checkout command have some difficulties to work. You may have to re-test several times (1-20 times) to finally succeed.', 'SL_framework')."<br/>\n" ; 
					echo __('Do not panic: once the checkout have worked one time, the update command will be used and it is far more robust!', 'SL_framework')."<br/>\n" ; 
					if (count($out)>0) {
						echo "<br/>".__('NOTE: The command outputs the following information:', 'SL_framework')."<br/>\n" ; 
						$isBeginSync = false ; 
						foreach ($out as $l) {
							if(strpos($l, $root) === FALSE) {
								echo $l."<br/>\n" ; 
							} else {
								if (!$isBeginSync) {
									$isBeginSync = true ; 
									echo __('The checkout have begun but have been interrupted without any reason!', 'SL_framework')."<br/>\n" ; 
								}
							}
						}
					} 
				} 
				echo "</p>\n" ; 
			}
			
			
			// If it is unsuccessuful,  we delete the local cache
			if ($value!=0) {
				if (is_dir($root)) {
					Utils::rm_rec($root) ; 
				}
			}
			
			return $value ; 
		}
		
		
		/** ====================================================================================================================================================
		* Add
		* 
		* @return void
		*/
		function add($root, $file) {
			$value = 99 ; 
			
			$f = str_replace($root,"",$file) ; 
			$added = false ; 
			
			// Change directory
			chdir($root) ; 
			// Clean the SVN stuff (to remove any lock)
			exec($this->cmd." cleanup 2>&1", $out) ; 
	
			// We first check that the directory are SVN compliant :)
			$ad = explode("/",str_replace(basename($f),"",$f)) ; 
			$list_f = $root ; 
			foreach($ad as $d) {
				$list_f .= $d."/" ; 
				if (!is_dir($list_f)) {
					@mkdir($list_f, 0777, true) ; 
				}
				if (!is_dir($list_f.".svn/")) {
					$added = true ; 
					exec($this->cmd." add ".str_replace($root,'',$list_f)." 2>&1", $out) ; 
				}
			}
			
			// We add the file
			if (!$added) {
				exec($this->cmd." add ".$f." 2>&1", $out, $value) ; 
			}
			echo "<p class='console'>\n" ; 
			echo sprintf(__('%s returns the following code: %s', 'SL_framework'), "*Add*", "<b>".$value."</b><br/>")."\n" ; 
			foreach ($out as $l) {
				echo $l."<br/>\n" ; 
			}
			echo "</p>\n" ; 
			
			return $value ; 
		}
		
		
		/** ====================================================================================================================================================
		* SVN delete
		* 
		* @return void
		*/
		function delete($root, $file) {
			
			$value = 99 ; 
			
			chdir($root) ; 
			
			exec($this->cmd." cleanup 2>&1", $out, $value) ; 
			exec($this->cmd." delete ".$file." 2>&1", $out, $value) ; 
			
			// On affiche
			if ($print) {
				echo "<p class='console'>\n" ; 
				echo sprintf(__('%s returns the following code: %s', 'SL_framework'), "*Delete*", "<b>".$value."</b><br/>")."\n" ; 
				foreach ($out as $l) {
					echo $l."<br/>\n" ; 
				}
				echo "</p>\n" ; 
			}
			
			return $value ; 
		}
		/** ====================================================================================================================================================
		* Commit
		* 
		* @return void
		*/
		function commit($root, $login, $pass, $comment) {
			$value = 99 ; 
			// Change directory
			chdir($root) ; 
								
			// Clean the SVN stuff (to remove any lock)
			exec($this->cmd." cleanup 2>&1", $out) ; 
			
			// We commit the change
			exec($this->cmd." commit ".$f." --username ".$login." --password ".$pass." --message \"".$comment."\" 2>&1", $out, $value) ; 
	
			echo "<p class='console'>\n" ; 
				echo sprintf(__('%s returns the following code: %s', 'SL_framework'), "*Commit*", "<b>".$value."</b><br/>")."\n" ; 
			foreach ($out as $l) {
				echo $l."<br/>\n" ; 
			}
			echo "</p>\n" ; 
			
			return $value ; 
		}	
		
		
		
		
		
		/** ====================================================================================================================================================
		* Callback for displaying the SVN popup
		* 
		* @access private
		* @return void
		*/		
		
		function svn_show_popup() {
		
			// get the arguments
			$plugin = $_POST['plugin'];
			$sens = $_POST['sens'];

			if ($sens=="to_repo") {
				$title = sprintf(__('Update the SVN repository %s with your current local plugin files', 'SL_framework'),'<em>'.$plugin.'</em>') ;
			}
			if ($sens=="to_local") {
				$title = sprintf(__('Overwrite the local plugin %s files with files stored the SVN repository', 'SL_framework'),'<em>'.$plugin.'</em>') ; ;
			}
			
			ob_start() ; 
			echo "<div id='svn_div'>" ; 
			svnAdmin::func_svn_prepare($plugin, $sens) ; 	
			echo "</div>" ; 
			$content = ob_get_clean() ; 	

			$popup = new popupAdmin($title, $content, "") ; 
			$popup->render() ; 
			die() ; 
		}
		
		/** ====================================================================================================================================================
		* Callback for preparing SVN command
		* 
		* @access private
		* @return void
		*/			
		function svn_prepare() {
			// get the arguments
			$plugin = $_POST['plugin'];
			$sens = $_POST['sens'];
			svnAdmin::func_svn_prepare($plugin, $sens) ; 
			die() ; 
		}
		
		/** ====================================================================================================================================================
		* Function for preparing SVN command
		* 
		* @access private
		* @return void
		*/			
		
		function func_svn_prepare($plugin, $sens) {
		
			$local_cache = WP_CONTENT_DIR."/sedlex/svn/".$plugin ; 
			$repository = "http://svn.wp-plugins.org/".$plugin ; 
			$svn = new svnAdmin("http://svn.wp-plugins.org/") ; 
			
			
			
			
			// On met a jour le cache local !
			echo "<h3>".__('Update the local cache', 'SL_framework')."</h3>" ; 
			$resulta = $svn->update_checkout($local_cache, $repository) ; 
			if ($resulta==0) {
				echo "<br/><h3>".__('Compare the local cache with the plugins files', 'SL_framework')."</h3>" ; 
				$folddiff = new foldDiff() ; 
				
				if ($sens=="to_repo") {
					// DIFF
					$result = $folddiff->diff(WP_PLUGIN_DIR."/".$plugin, $local_cache."/trunk") ; 
					
					$folddiff->render() ; 
					// Confirmation asked
					echo "<h3>".__('Confirmation', 'SL_framework')."</h3>" ; 
					
					echo "<p>".__('Commit comment:', 'SL_framework')."</p>" ; 
					echo 	"<p><textarea cols='70' rows='5' name='svn_comment' id='svn_comment'/></textarea></p>\n" ;  
					echo "<p id='svn_button'><input onclick='svnToRepo(\"".$plugin."\") ; return false ; ' type='submit' name='submit' class='button-primary validButton' value='".__('Yes, the SVN version will be deleted and be replaced by the local version', 'SL_framework')."' /></p>" ;  
					echo "<p><img id='wait_svn' src='".WP_PLUGIN_URL.'/'.str_replace(basename(__FILE__),"",plugin_basename(__FILE__))."core/img/ajax-loader.gif' style='display:none;'></p>" ; 
				}	
				
				
				if ($sens=="to_local") { 
					$folddiff->diff($local_cache."/trunk", WP_PLUGIN_DIR."/".$plugin) ; 
					$folddiff->render() ; 
					// Confirmation asked
					echo "<h3>".__('Confirmation', 'SL_framework')."</h3>" ; 
					
					echo "<p id='svn_button'><input onclick='repoToSvn(\"".$plugin."\") ; return false ; ' type='submit' name='submit' class='button-primary validButton' value='".__('Yes, the local version will be deleted and be replaced by the files stored on the SVN repository', 'SL_framework')."' /></p>" ;  
					echo "<p><img id='wait_svn' src='".WP_PLUGIN_URL.'/'.str_replace(basename(__FILE__),"",plugin_basename(__FILE__))."core/img/ajax-loader.gif' style='display:none;'></p>" ; 

				}
			} else {
				echo "<p><a href='#' onClick='reTrySvnPreparation(\"".$plugin."\", \"to_repo\"); return false;'>".__('Retry the SVN preparation!', 'SL_framework')."</a> " ; 
				echo " <img src='".WP_PLUGIN_URL.'/'.str_replace(basename(__FILE__),"",plugin_basename(__FILE__))."core/img/refresh.png'>" ; 
				echo " <img id='wait_svn' src='".WP_PLUGIN_URL.'/'.str_replace(basename(__FILE__),"",plugin_basename(__FILE__))."core/img/ajax-loader.gif' style='display:none;'></p>" ; 
			} 
		}
		
		/** ====================================================================================================================================================
		* Callback for SVN to repository
		* 
		* @access private
		* @return void
		*/		
		function svn_to_repo() {
			// get the arguments
			$plugin = $_POST['plugin'];
			$comment = $_POST['comment'];

			$path = WP_PLUGIN_DIR."/".$plugin ; 
			$local = WP_CONTENT_DIR."/sedlex/svn/".$plugin ; 

			// We get the list of the diff
			$svn = new svnAdmin() ; 
			$diff = new foldDiff();
			$fold = $diff->diff($path, $local."/trunk");
			
			foreach ($fold as $f) {
			
				// We add the file if needed
				if (($f[1]==2)&&($f[2]!="directory")) { // ADDED
					// On cree le repertoire s il n existe pas
					$directory = str_replace(basename($f[3]),"",$local."/trunk/".$f[3]) ; 
					
					if (!is_dir($directory)) {
						mkdir($directory, 0777, true) ; 
					}
					
					copy ( $path."/".$f[3], $local."/trunk/".$f[3]) ; 
					
					echo "<p>".sprintf(__('Add a file: %s', 'SL_framework')," <code>".$f[3]."</code>")."</p>\n" ; 
					
					$result = $svn->add($local."/trunk/",$f[3]) ; 
					if ($result != 0) {
						// We delete the file 
						unlink($local."/trunk/".$f[3]) ; 
					}
				}
				
				if (($f[1]==3)&&($f[2]!="directory")) { // MODIFIED
					copy ( $path."/".$f[3], $local."/trunk/".$f[3]) ; 
				}
				
				if (($f[1]==1)&&($f[2]!="directory")) {// DELETED
					echo "<p>".sprintf(__('Delete a file: %s', 'SL_framework')," <code>".$f[3]."</code>")."</p>\n" ; 
					$svn->delete($local."/trunk/",$f[3]) ; 
				}
			}
									
			echo "<p>".__('Final commit:', 'SL_framework')." <code>commit</code></p>\n" ; 
			$svn->commit($local, get_option('SL_framework_SVN_login', ""), get_option('SL_framework_SVN_password', ""), $comment) ; 
			
			echo "<p> </p>" ; 
			echo "<p>".__("The commit has ended and you may restart a normal life by closing the window...", 'SL_framework')."</p>" ; 
			echo "<p>".__("Thank you!", 'SL_framework')."</p>" ; 
			
			die() ; 
		}
		
		/** ====================================================================================================================================================
		* Callback for SVN to repository
		* 
		* @access private
		* @return void
		*/		
		
		function repo_to_svn() {
			// get the arguments
			$plugin = $_POST['plugin'];
			$comment = $_POST['comment'];

			$path = WP_PLUGIN_DIR."/".$plugin ; 
			$local = WP_CONTENT_DIR."/sedlex/svn/".$plugin ; 

			// We get the list of the diff
			$svn = new svnAdmin() ; 
			$diff = new foldDiff();
			$fold = $diff->diff($local."/trunk", $path);
			
			echo "<p class='console'>\n" ; 
			echo "To local: <br/>\n" ;
			
			foreach ($fold as $f) {
						
				// We add the file if needed
				if (($f[1]==2)&&($f[2]!="directory")) { // ADDED
					// On cree le repertoire s il n existe pas
					$directory = str_replace(basename($f[3]),"",$path."/".$f[3]) ; 
					
					if (!is_dir($directory)) {
						mkdir($directory, 0777, true) ; 
					}
					
					copy ( $local."/trunk/".$f[3], $path."/".$f[3] ) ; 
					echo "A ".$f[3]."<br/>\n" ;
					
				}
				
				if (($f[1]==3)&&($f[2]!="directory")) { // MODIFIED
					copy ($local."/trunk/".$f[3], $path."/".$f[3]) ; 
					echo "U ".$f[3]."<br/>\n" ;
				}
				
				if (($f[1]==1)&&($f[2]!="directory")) {// DELETED
					unlink ($path."/".$f[3]) ; 
					echo "D ".$f[3]."<br/>\n" ;
				}
			}
			echo "</p>\n" ; 
	
			echo "<p> </p>" ; 
			echo "<p>".__("The overwrite has ended and you may restart a normal life by closing the window...", 'SL_framework')."</p>" ; 
			echo "<p>".__("Thank you!", 'SL_framework')."</p>" ; 
			
			die() ; 
		}
		
		
		
		
		
		
		
		
		
		
		
	}
}

?>